<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookstore Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #eb6a6a;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        header h1 {
            font-size: 2rem;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-bottom: 20px;
            color: #eb6a6a;
            border-bottom: 2px solid #eb6a6a;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        button {
            background-color: #408940;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2d6b2d;
        }
        button.delete {
            background-color: #d9534f;
            padding: 8px 12px;
            font-size: 14px;
            margin: 0;
        }
        button.delete:hover {
            background-color: #c9302c;
        }
        button.edit {
            background-color: #5bc0de;
            padding: 8px 12px;
            font-size: 14px;
            margin: 0 5px 0 0;
        }
        button.edit:hover {
            background-color: #46b8da;
        }
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }
        .book-card {
            background-color: #f9f9f9;
            border-left: 4px solid #eb6a6a;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .book-card:hover {
            background-color: #f0f0f0;
        }
        .book-card.active {
            background-color: #ffe6e6;
            border-left-color: #408940;
        }
        .book-card h4 {
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }
        .book-card p {
            font-size: 12px;
            color: #666;
            margin: 2px 0;
        }
        .book-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .chapters-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }
        .chapter-item {
            background-color: #f0f7ff;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .message {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: none;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .upload-area {
            border: 3px dashed #eb6a6a;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover,
        .upload-area.dragover {
            background-color: #ffe6e6;
            border-color: #408940;
        }
        .upload-area p {
            margin: 10px 0;
            color: #666;
        }
        .upload-area.dragover {
            background-color: #e6f5e6;
        }
        #bookFileInput, #chapterFileInput {
            display: none;
        }
        .file-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .file-item {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .file-progress {
            width: 100%;
            height: 4px;
            background-color: #ddd;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        .file-progress-bar {
            height: 100%;
            background-color: #408940;
            width: 0%;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal-header {
            margin-bottom: 20px;
            border-bottom: 2px solid #eb6a6a;
            padding-bottom: 10px;
        }
        .modal-header h2 {
            color: #eb6a6a;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Bookstore Admin Panel</h1>
            <p>Add, edit, and manage your books and chapters</p>
        </header>

        <div class="admin-grid">
            <!-- Add Books Section -->
            <div class="section">
                <h2>üì§ Add Books</h2>
                <div id="addBookMessage" class="message"></div>
                
                <div class="upload-area" id="bookUploadArea">
                    <p style="font-size: 28px;">üìö</p>
                    <p><strong>Drag & drop book files here</strong></p>
                    <p style="font-size: 12px; color: #999;">or click to browse (PDF, EPUB, TXT)</p>
                </div>
                
                <input type="file" id="bookFileInput" multiple accept=".pdf,.epub,.txt">
                <div class="file-list" id="bookFileList" style="display:none;"></div>
            </div>

            <!-- Your Books Section -->
            <div class="section">
                <h2>üìö Your Books</h2>
                <div id="booksMessage" class="message"></div>
                <div class="books-grid" id="booksList">
                    <p style="color: #999; grid-column: 1/-1;">Loading books...</p>
                </div>
            </div>
        </div>

        <!-- Book Editor Section -->
        <div class="section" id="editorSection" style="display:none;">
            <h2>‚úèÔ∏è Edit Book & Manage Chapters</h2>
            <div id="editorMessage" class="message"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- Book Edit Form -->
                <div style="padding: 15px; background-color: #f9f9f9; border-radius: 5px;">
                    <h3 style="margin-bottom: 15px; color: #eb6a6a;">Book Details</h3>
                    
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editBookTitle">
                    </div>
                    
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" id="editBookAuthor">
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editBookDescription"></textarea>
                    </div>
                    
                    <button onclick="saveBookEdits()">üíæ Save Changes</button>
                    <button class="delete" onclick="deleteBook()">üóëÔ∏è Delete Book</button>
                </div>

                <!-- Add Chapters Section -->
                <div style="padding: 15px; background-color: #f9f9f9; border-radius: 5px;">
                    <h3 style="margin-bottom: 15px; color: #eb6a6a;">Add Chapters</h3>
                    
                    <div class="upload-area" id="chapterUploadArea">
                        <p style="font-size: 24px;">üìñ</p>
                        <p><strong>Drag & drop chapter files</strong></p>
                        <p style="font-size: 12px; color: #999;">or click to browse (PDF, EPUB)</p>
                    </div>
                    
                    <input type="file" id="chapterFileInput" multiple accept=".pdf,.epub">
                    <div class="file-list" id="chapterFileList" style="display:none;"></div>
                </div>
            </div>

            <!-- Chapters List Section -->
            <div class="chapters-section">
                <h3>üìñ Chapters in this Book</h3>
                <div id="chaptersList"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const API_URL = './api';
        let selectedBookId = null;

        // Load books on page load
        function loadBooks() {
            $.ajax({
                url: `${API_URL}/get_books.php`,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data) {
                        let html = '';
                        if (response.data.length === 0) {
                            html = '<p style="color: #999; grid-column: 1/-1;">No books yet. Upload one to get started!</p>';
                        } else {
                            response.data.forEach(book => {
                                html += `
                                    <div class="book-card" onclick="selectBook(${book.id})">
                                        <h4>${book.title || 'Untitled'}</h4>
                                        <p><strong>Author:</strong> ${book.author || 'Unknown'}</p>
                                        <p><strong>ID:</strong> ${book.id}</p>
                                        <div class="book-actions">
                                            <button class="edit" onclick="event.stopPropagation(); deleteBook(${book.id})">Delete</button>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        $('#booksList').html(html);
                    }
                },
                error: function() {
                    $('#booksList').html('<p style="color: #d9534f; grid-column: 1/-1;">Error loading books</p>');
                }
            });
        }

        // Select book to edit
        function selectBook(bookId) {
            selectedBookId = bookId;
            
            // Highlight selected book
            document.querySelectorAll('.book-card').forEach(card => card.classList.remove('active'));
            event.target.closest('.book-card').classList.add('active');
            
            // Show editor section
            $('#editorSection').show();
            
            // Load book details
            $.ajax({
                url: `${API_URL}/get_book.php?id=${bookId}`,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data) {
                        const book = response.data;
                        $('#editBookTitle').val(book.title || '');
                        $('#editBookAuthor').val(book.author || '');
                        $('#editBookDescription').val(book.description || '');
                        
                        // Load chapters
                        loadChapters(bookId);
                    }
                }
            });
        }

        // Load chapters
        function loadChapters(bookId) {
            $.ajax({
                url: `${API_URL}/get_book.php?id=${bookId}`,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data.chapters) {
                        let html = '';
                        if (response.data.chapters.length === 0) {
                            html = '<p style="color: #999;">No chapters yet. Upload some files to add chapters.</p>';
                        } else {
                            response.data.chapters.forEach(ch => {
                                html += `
                                    <div class="chapter-item">
                                        <span><strong>Chapter ${ch.chapter_number}:</strong> ${ch.title || 'Untitled'}</span>
                                        <button class="delete" onclick="deleteChapter(${ch.id})">Delete</button>
                                    </div>
                                `;
                            });
                        }
                        $('#chaptersList').html(html);
                    }
                }
            });
        }

        // Save book edits
        function saveBookEdits() {
            if (!selectedBookId) {
                showMessage('editorMessage', 'Please select a book first', 'error');
                return;
            }

            const data = {
                id: selectedBookId,
                title: $('#editBookTitle').val(),
                author: $('#editBookAuthor').val(),
                description: $('#editBookDescription').val()
            };

            $.ajax({
                url: `${API_URL}/admin/update_book.php`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        showMessage('editorMessage', 'Book updated successfully!', 'success');
                        loadBooks();
                    } else {
                        showMessage('editorMessage', 'Error: ' + response.error, 'error');
                    }
                },
                error: function() {
                    showMessage('editorMessage', 'Error saving changes', 'error');
                }
            });
        }

        // Delete book
        function deleteBook(bookId) {
            bookId = bookId || selectedBookId;
            if (!bookId) return;

            if (!confirm('Are you sure you want to delete this book and all its chapters?')) {
                return;
            }

            $.ajax({
                url: `${API_URL}/admin/delete_book.php`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: bookId }),
                success: function(response) {
                    if (response.success) {
                        showMessage('editorMessage', 'Book deleted successfully!', 'success');
                        selectedBookId = null;
                        $('#editorSection').hide();
                        loadBooks();
                    } else {
                        showMessage('editorMessage', 'Error: ' + response.error, 'error');
                    }
                }
            });
        }

        // Delete chapter
        function deleteChapter(chapterId) {
            if (!confirm('Delete this chapter?')) return;

            $.ajax({
                url: `${API_URL}/admin/delete_chapter.php`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: chapterId }),
                success: function(response) {
                    if (response.success) {
                        showMessage('editorMessage', 'Chapter deleted!', 'success');
                        loadChapters(selectedBookId);
                    } else {
                        showMessage('editorMessage', 'Error deleting chapter', 'error');
                    }
                }
            });
        }

        // Show/hide messages
        function showMessage(elementId, message, type) {
            const $msg = $(`#${elementId}`);
            $msg.text(message).removeClass('success error').addClass(type);
            setTimeout(() => {
                $msg.fadeOut('slow', function() { $msg.show(); });
            }, 3000);
        }

        // ====== DRAG AND DROP FOR BOOKS ======
        const bookUploadArea = document.getElementById('bookUploadArea');
        const bookFileInput = document.getElementById('bookFileInput');

        if (bookUploadArea) {
            bookUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                bookUploadArea.classList.add('dragover');
            });

            bookUploadArea.addEventListener('dragleave', () => {
                bookUploadArea.classList.remove('dragover');
            });

            bookUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                bookUploadArea.classList.remove('dragover');
                handleBookFiles(e.dataTransfer.files);
            });

            bookUploadArea.addEventListener('click', () => {
                bookFileInput.click();
            });
        }

        if (bookFileInput) {
            bookFileInput.addEventListener('change', (e) => {
                handleBookFiles(e.target.files);
            });
        }

        function handleBookFiles(files) {
            Array.from(files).forEach(file => uploadBookFile(file));
        }

        function uploadBookFile(file) {
            // Validate file type
            const validExtensions = ['.pdf', '.epub', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showMessage('addBookMessage', `Invalid file: ${file.name}. Only PDF, EPUB, TXT allowed.`, 'error');
                return;
            }

            // Clear previous files and show list
            $('#bookFileList').html('').show();
            
            const fileId = 'book-file-' + Date.now();
            const fileItemHtml = `
                <div class="file-item" id="${fileId}">
                    <div>
                        <p><strong>${file.name}</strong></p>
                        <label style="margin-bottom: 5px; display: block;">Book Title</label>
                        <input type="text" placeholder="Book title" class="book-title-input" value="${file.name.split('.')[0]}" style="width: 100%; padding: 5px; margin-bottom: 10px;">
                        <label style="margin-bottom: 5px; display: block;">Author</label>
                        <input type="text" placeholder="Author name" class="book-author-input" style="width: 100%; padding: 5px; margin-bottom: 10px;">
                        <button type="button" onclick="uploadBookConfirm('${fileId}')" style="background-color: #408940; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Upload Book</button>
                    </div>
                    <div class="file-progress">
                        <div class="file-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            $('#bookFileList').append(fileItemHtml);
            
            // Store file reference for later upload
            window.pendingBookFile = { file: file, fileId: fileId };
        }

        function uploadBookConfirm(fileId) {
            if (!window.pendingBookFile || window.pendingBookFile.fileId !== fileId) {
                showMessage('addBookMessage', 'Error: File reference lost. Try uploading again.', 'error');
                return;
            }

            const file = window.pendingBookFile.file;
            const bookTitle = $(`#${fileId} .book-title-input`).val().trim();
            const bookAuthor = $(`#${fileId} .book-author-input`).val().trim();

            if (!bookTitle) {
                showMessage('addBookMessage', 'Please enter a book title', 'error');
                return;
            }

            if (!bookAuthor) {
                showMessage('addBookMessage', 'Please enter an author name', 'error');
                return;
            }

            // Start actual file upload
            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: `${API_URL}/admin/upload_book.php`,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            $(`#${fileId} .file-progress-bar`).css('width', percentComplete + '%');
                        }
                    }, false);
                    return xhr;
                },
                success: function(response) {
                    if (response.success) {
                        // Create book in database with collected data
                        createBookInDatabase(bookTitle, bookAuthor, response.file_content, response.file_name, response.file_extension, response.file_size);
                        
                        $(`#${fileId}`).fadeOut(500, function() { $(this).remove(); });
                        if ($('#bookFileList').children().length === 0) {
                            $('#bookFileList').hide();
                        }
                        bookFileInput.value = '';
                        window.pendingBookFile = null;
                    } else {
                        // Clear form on error
                        $(`#${fileId}`).remove();
                        showMessage('addBookMessage', `Upload failed: ${response.error}`, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    // Try to parse error response
                    let errorMsg = 'Error uploading file';
                    if (xhr.responseText) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg = response.error || errorMsg;
                        } catch (e) {
                            errorMsg = xhr.responseText || error || 'Unknown error';
                        }
                    }
                    // Clear form on error
                    $(`#${fileId}`).remove();
                    showMessage('addBookMessage', errorMsg, 'error');
                }
            });
        }

        function createBookInDatabase(title, author, fileContent, fileName, fileExtension, fileSize) {
            const data = {
                title: title,
                author: author,
                description: `Uploaded from ${fileName}`,
                file_content: fileContent,
                file_name: fileName,
                file_extension: fileExtension,
                file_size: fileSize
            };

            $.ajax({
                url: `${API_URL}/admin/add_book.php`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        showMessage('addBookMessage', `Book "${title}" added successfully!`, 'success');
                        loadBooks();
                    } else {
                        // Show detailed error message
                        let errorMsg = response.error || 'Unknown error';
                        console.error('Add book error:', response);
                        showMessage('addBookMessage', 'Error: ' + errorMsg, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    let errorMsg = 'Error creating book';
                    try {
                        if (xhr.responseText) {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg = response.error || errorMsg;
                        }
                    } catch (e) {
                        errorMsg = xhr.status + ': ' + xhr.statusText;
                    }
                    showMessage('addBookMessage', errorMsg, 'error');
                }
            });
        }

        // ====== DRAG AND DROP FOR CHAPTERS ======
        const chapterUploadArea = document.getElementById('chapterUploadArea');
        const chapterFileInput = document.getElementById('chapterFileInput');

        if (chapterUploadArea) {
            chapterUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                chapterUploadArea.classList.add('dragover');
            });

            chapterUploadArea.addEventListener('dragleave', () => {
                chapterUploadArea.classList.remove('dragover');
            });

            chapterUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                chapterUploadArea.classList.remove('dragover');
                handleChapterFiles(e.dataTransfer.files);
            });

            chapterUploadArea.addEventListener('click', () => {
                chapterFileInput.click();
            });
        }

        if (chapterFileInput) {
            chapterFileInput.addEventListener('change', (e) => {
                handleChapterFiles(e.target.files);
            });
        }

        function handleChapterFiles(files) {
            if (!selectedBookId) {
                showMessage('editorMessage', 'Please select a book first', 'error');
                return;
            }
            Array.from(files).forEach(file => uploadChapterFile(file));
        }

        function uploadChapterFile(file) {
            if (!selectedBookId) {
                showMessage('editorMessage', 'Please select a book first', 'error');
                return;
            }

            // Validate file type
            const validExtensions = ['.pdf', '.epub'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showMessage('editorMessage', `Invalid file: ${file.name}. Only PDF, EPUB allowed.`, 'error');
                return;
            }

            $('#chapterFileList').show();
            
            const fileId = 'chapter-file-' + Date.now();
            const fileName = file.name.split('.')[0];
            const chapterMatch = fileName.match(/ch[apter]*[\s_-]*(\d+)/i);
            let chapterNumber = chapterMatch ? chapterMatch[1] : '';

            const chapterNumId = fileId + '-num';
            const chapterTitleId = fileId + '-title';
            
            const fileItemHtml = `
                <div class="file-item" id="${fileId}">
                    <div>
                        <p><strong>${file.name}</strong></p>
                        <label for="${chapterNumId}" style="margin-bottom: 5px; display: block;">Chapter Number</label>
                        <input type="number" id="${chapterNumId}" name="chapter_num" placeholder="Chapter #" value="${chapterNumber}" class="chapter-num-input" style="width: 100px; padding: 5px; margin-bottom: 10px;">
                        <label for="${chapterTitleId}" style="margin-bottom: 5px; display: block;">Chapter Title</label>
                        <input type="text" id="${chapterTitleId}" name="chapter_title" placeholder="Chapter title" class="chapter-title-input" style="width: 100%; padding: 5px;">
                    </div>
                    <div class="file-progress">
                        <div class="file-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            $('#chapterFileList').append(fileItemHtml);

            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: `${API_URL}/admin/upload_book.php`,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            $(`#${fileId} .file-progress-bar`).css('width', percentComplete + '%');
                        }
                    }, false);
                    return xhr;
                },
                success: function(response) {
                    if (response.success) {
                        const chapterNum = $(`#${fileId} .chapter-num-input`).val();
                        const chapterTitle = $(`#${fileId} .chapter-title-input`).val();

                        if (chapterNum && chapterTitle) {
                            createChapterInDatabase(chapterNum, chapterTitle, response.file_content, response.file_name, response.file_extension);
                        } else {
                            showMessage('editorMessage', 'Please fill in chapter number and title', 'error');
                        }

                        $(`#${fileId}`).fadeOut(500, function() { $(this).remove(); });
                        chapterFileInput.value = '';
                    } else {
                        showMessage('editorMessage', `Error: ${response.error}`, 'error');
                    }
                },
                error: function() {
                    showMessage('editorMessage', `Error uploading file`, 'error');
                }
            });
        }

        function createChapterInDatabase(chapterNum, chapterTitle, fileContent, fileName, fileExtension) {
            const data = {
                book_id: selectedBookId,
                chapter_number: parseInt(chapterNum),
                title: chapterTitle,
                file_content: fileContent,
                file_name: fileName,
                file_extension: fileExtension
            };

            $.ajax({
                url: `${API_URL}/admin/add_chapter.php`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        showMessage('editorMessage', 'Chapter added successfully!', 'success');
                        loadChapters(selectedBookId);
                    } else {
                        showMessage('editorMessage', 'Error: ' + response.error, 'error');
                    }
                },
                error: function() {
                    showMessage('editorMessage', 'Error adding chapter', 'error');
                }
            });
        }

        // Load books on page load
        $(document).ready(function() {
            loadBooks();
        });
    </script>
</body>
</html>
